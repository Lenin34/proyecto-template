<div class="modal fade" id="modalNew" tabindex="-1" aria-labelledby="modalNewLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-form">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalNewLabel">NUEVO EVENTO</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-4">
                {{ form_start(form, {'attr': {'id': 'newEventForm', 'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}
                <div class="row g-3">
                    {# Imagen del evento - Centrada arriba #}
                    <div class="col-12 text-center mb-3">
                        <label for="event_image_input" class="form-label">IMAGEN DEL EVENTO</label>
                        <div class="file-upload-wrapper mx-auto" style="max-width: 350px;">
                            {{ form_widget(form.image, {'attr': {'class': 'form-control', 'id': 'event_image_input'}}) }}
                            <div class="file-upload-display" id="eventImageDisplay">
                                <div class="file-upload-icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="file-upload-text">
                                    <div class="upload-title">Subir imagen</div>
                                    <div class="upload-subtitle">JPG, PNG o GIF (máx. 5MB)</div>
                                </div>
                                <img id="eventImagePreview" src="" alt="Preview" class="position-absolute top-0 start-0 w-100 h-100 rounded-3" style="object-fit: cover; display: none;">
                            </div>
                        </div>
                        <div class="text-danger small mt-1">{{ form_errors(form.image) }}</div>
                    </div>

                    {# Título #}
                    <div class="col-md-12">
                        <label for="event_title" class="form-label">TÍTULO</label>
                        {{ form_widget(form.title, {'attr': {'class': 'form-control', 'placeholder': 'Título del evento', 'id': 'event_title'}}) }}
                        <div class="text-danger small mt-1">{{ form_errors(form.title) }}</div>
                    </div>

                    {# Región #}
                    <div class="col-md-12">
                        <label for="event_region" class="form-label">REGIÓN</label>
                        {{ form_widget(form.region, {'attr': {'class': 'form-select', 'id': 'event_region'}}) }}
                        <div class="text-danger small mt-1">{{ form_errors(form.region) }}</div>
                    </div>

                    {# Fechas #}
                    <div class="col-md-6">
                        <label for="event_start_date" class="form-label">FECHA INICIO</label>
                        {{ form_widget(form.start_date, {'attr': {'class': 'form-control', 'id': 'event_start_date'}}) }}
                        <div class="text-danger small mt-1">{{ form_errors(form.start_date) }}</div>
                    </div>
                    <div class="col-md-6">
                        <label for="event_end_date" class="form-label">FECHA FIN</label>
                        {{ form_widget(form.end_date, {'attr': {'class': 'form-control', 'id': 'event_end_date'}}) }}
                        <div class="text-danger small mt-1">{{ form_errors(form.end_date) }}</div>
                    </div>

                    {# Descripción #}
                    <div class="col-md-12">
                        <label for="event_description" class="form-label">DESCRIPCIÓN</label>
                        {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': '3', 'placeholder': 'Descripción del evento', 'id': 'event_description'}}) }}
                        <div class="text-danger small mt-1">{{ form_errors(form.description) }}</div>
                    </div>

                    {# Empresas - Select2 Multiple #}
                    <div class="col-12">
                        <label class="form-label">EMPRESAS</label>
                        <select
                            name="selected_companies[]" id="newEventCompanies" multiple class="form-select form-control-dark">
                            <option value="">Cargando empresas...</option>
                        </select>
                        <div class="form-text text-muted small mt-1">Si no seleccionas ninguna empresa, el evento será global (todas las empresas).</div>
                    </div>

                    {# Checkbox de Notificación #}
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="send_notification" id="sendNotificationCheckbox" checked>
                            <label class="form-check-label" for="sendNotificationCheckbox">
                                Enviar notificación al crear
                            </label>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-0 px-0 mt-4">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">CANCELAR</button>
                    <button type="submit" class="btn btn-primary px-4" style="background-color: var(--color-accent-blue); border: none;">GUARDAR</button>
                </div>
                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	// Preview de imagen para nuevo evento
	const imageInput = document.getElementById('event_image_input');
	const imagePreview = document.getElementById('eventImagePreview');
	const uploadText = document.querySelector('#eventImageDisplay .file-upload-text');
	const uploadIcon = document.querySelector('#eventImageDisplay .file-upload-icon');

	if (imageInput) {
		imageInput.addEventListener('change', function(e) {
			if (this.files && this.files[0]) {
				const reader = new FileReader();
				reader.onload = function(e) {
					imagePreview.src = e.target.result;
					imagePreview.style.display = 'block';
					if (uploadText) uploadText.style.display = 'none';
					if (uploadIcon) uploadIcon.style.display = 'none';
				}
				reader.readAsDataURL(this.files[0]);
			}
		});
	}

	// Initialize Select2 for new event modal
	const companySelect = $('#newEventCompanies');

	// Load companies grouped by region from backend
	fetch('{{ path('app_company_list', {'dominio': app.request.attributes.get('dominio')}) }}')
		.then(response => response.json())
		.then(groupedData => {
			// Clear existing options
			companySelect.empty();

			// Add companies grouped by region using optgroups
			groupedData.forEach(group => {
				const optgroup = $('<optgroup>').attr('label', group.region_name);

				group.companies.forEach(company => {
					const option = new Option(company.name, company.id, false, false);
					optgroup.append(option);
				});

				companySelect.append(optgroup);
			});

			// Initialize Select2 for companies after options are loaded
			companySelect.select2({
				theme: 'bootstrap-5',
				placeholder: 'Selecciona empresas (vacío = todas)',
				allowClear: true,
				width: '100%',
				closeOnSelect: false,
				dropdownParent: $('#modalNew'),
				templateResult: function(option) {
					if (!option.id) return option.text;
					return $('<span><i class="fas fa-building me-2"></i>' + option.text + '</span>');
				},
				templateSelection: function(option) {
					if (!option.id) return option.text;
					return $('<span><i class="fas fa-building me-1"></i>' + option.text + '</span>');
				}
			});
		})
		.catch(error => {
			console.error('Error loading companies:', error);
			Swal.fire({
				icon: 'error',
				title: 'Error',
				text: 'No se pudieron cargar las empresas'
			});
		});

	// Reset form when modal is closed
	$('#modalNew').on('hidden.bs.modal', function() {
		companySelect.val(null).trigger('change');
	});
});
</script>
