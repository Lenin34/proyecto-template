{# Modal de Editar Evento #}
<div class="modal fade" id="modalEditEvent" tabindex="-1" aria-labelledby="modalEditEventLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-form">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditEventLabel">
                    <i class="fas fa-edit me-2"></i>
                    Editar Evento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm" method="post" enctype="multipart/form-data">
                    <div class="row g-3">
                        {# Imagen con estructura controlada #}
                        <div class="col-12 text-center mb-3">
                            <label for="editEventImage" class="form-label">Imagen (Dejar vacío para mantener actual)</label>
                            <div class="file-upload-wrapper mx-auto" style="max-width: 350px; position: relative;">
                                <input type="file" name="event[image]" id="editEventImage" class="form-control" accept="image/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10;">
                                <div class="file-upload-display" id="editEventImageDisplay">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <div class="upload-title">Cambiar imagen</div>
                                        <div class="upload-subtitle">Click para seleccionar nueva</div>
                                    </div>
                                    <img id="editEventImagePreview" src="" alt="Preview" class="position-absolute top-0 start-0 w-100 h-100 rounded-3" style="object-fit: cover; display: none; z-index: 5;">
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="editEventTitle" class="form-label">Título *</label>
                            <input type="text" name="event[title]" id="editEventTitle" required class="form-control form-control-dark">
                        </div>
                        <div class="col-12">
                            <label for="editEventRegion" class="form-label">Región *</label>
                            <select name="event[region]" id="editEventRegion" required class="form-select form-control-dark">
                                <option value="">Cargando regiones...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editEventStartDate" class="form-label">Fecha Inicio *</label>
                            <input type="datetime-local" name="event[start_date]" id="editEventStartDate" required class="form-control form-control-dark">
                        </div>
                        <div class="col-md-6">
                            <label for="editEventEndDate" class="form-label">Fecha Fin *</label>
                            <input type="datetime-local" name="event[end_date]" id="editEventEndDate" required class="form-control form-control-dark">
                        </div>
                        <div class="col-12">
                            <label for="editEventDescription" class="form-label">Descripción *</label>
                            <textarea name="event[description]" id="editEventDescription" required class="form-control form-control-dark" rows="4"></textarea>
                        </div>
                        {# Empresas - Select2 #}
                        <div class="col-12">
                            <label for="editEventCompanies" class="form-label">Empresas</label>
                            <select name="selected_companies[]" id="editEventCompanies" class="form-select form-control-dark" multiple>
                                <option value="">Cargando empresas...</option>
                            </select>
                            <div class="form-text text-light opacity-50">Si no seleccionas ninguna empresa, el evento será global (todas las empresas).</div>
                        </div>
                    </div>

                    <input type="hidden" name="event[_token]" value="{{ csrf_token('event') }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="submit" form="editEventForm" class="btn btn-warning">
                    <i class="fas fa-save me-2"></i>
                    Actualizar Evento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica para previsualizar la imagen en el modal de edición
    const editImageInput = document.getElementById('editEventImage');
    const editImagePreview = document.getElementById('editEventImagePreview');

    if (editImageInput && editImagePreview) {
        editImageInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    editImagePreview.src = e.target.result;
                    editImagePreview.style.display = 'block';
                }
                reader.readAsDataURL(this.files[0]);
            } else {
                editImagePreview.style.display = 'none';
                editImagePreview.src = '';
            }
        });
    }

    // Load companies grouped by region for edit modal
    const companySelect = $('#editEventCompanies');

    fetch('{{ path('app_company_list', {'dominio': app.request.attributes.get('dominio')}) }}')
        .then(response => response.json())
        .then(groupedData => {
            // Clear existing options
            companySelect.empty();

            // Add companies grouped by region using optgroups
            groupedData.forEach(group => {
                const optgroup = $('<optgroup>').attr('label', group.region_name);

                group.companies.forEach(company => {
                    const option = new Option(company.name, company.id, false, false);
                    optgroup.append(option);
                });

                companySelect.append(optgroup);
            });

            // Initialize Select2 for companies after options are loaded
            companySelect.select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecciona empresas (vacío = todas)',
                allowClear: true,
                width: '100%',
                closeOnSelect: false,
                dropdownParent: $('#modalEditEvent'),
                templateResult: function(option) {
                    if (!option.id) return option.text;
                    return $('<span><i class="fas fa-building me-2"></i>' + option.text + '</span>');
                },
                templateSelection: function(option) {
                    if (!option.id) return option.text;
                    return $('<span><i class="fas fa-building me-1"></i>' + option.text + '</span>');
                }
            });
        })
        .catch(error => {
            console.error('Error loading companies:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar las empresas'
            });
        });
});
</script>
