{% extends 'base-login.html.twig' %}

{% set dominio = app.request.attributes.get('dominio') %}

{% block title %}Inicio de sesión
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		/* Corregir fondo para evitar deformación */
		body.bg-dark {
			background: linear-gradient(to bottom, #0B3F61 0%, #586975 100%) !important;
			background-attachment: fixed !important;
			background-repeat: no-repeat !important;
			background-size: 100% 100% !important;
			min-height: 100vh !important;
		}

		.logo-login {
			max-width: 200px;
			width: 100%;
			height: auto;
			margin-bottom: 1.5rem;
		}

		@media(max-width: 768px) {
			.logo-login {
				max-width: 150px;
			}
		}

		.password-wrapper {
			position: relative;
			width: 100%;
			max-width: 400px;
		}

		.password-toggle {
			position: absolute;
			right: 15px;
			top: 50%;
			transform: translateY(-50%);
			border: none;
			background: transparent;
			color: #6c757d;
			padding: 0;
			cursor: pointer;
			z-index: 10;
		}

		.password-toggle:hover {
			color: #495057;
		}

		.password-toggle:focus {
			outline: none;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="bg-dark text-white d-flex align-items-center justify-content-center vh-100">
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-md-7 col-lg-6">
					<div class="login-wrapper p-4 text-white">
						<div
							class="text-center mb-4 d-flex flex-column align-items-center">
							{# Logo dinámico del tenant actual con fallback #}
							<img src="{{ logoUrl }}" alt="Logo" class="logo-login"/>
							<h2 class="login-title">ACCESO ADMINISTRADOR</h2>
						</div>

						{% if error %}
							<div class="alert alert-danger d-none">{{ error.messageKey|trans(error.messageData, 'security') }}</div>
						{% endif %}

						<form method="post" action="{{ path('app_login', {'dominio': dominio}) }}" id="loginForm">
							<div class="form-group mb-3 d-flex flex-column align-items-center">
								<label for="inputEmail" class="form-label fw-light text-login">Correo Electronico</label>
								<div class="password-wrapper">
									<input type="email" name="email" id="inputEmail" class="form-control rounded-pill input-field" autocomplete="email" required autofocus>
								</div>
							</div>

							<div class="form-group mb-3 d-flex flex-column align-items-center">
								<label for="inputPassword" class="form-label fw-light text-login">Contraseña</label>
								<div class="password-wrapper">
									<input type="password" name="password" id="inputPassword" class="form-control rounded-pill input-field" autocomplete="current-password" required>
									<button type="button" class="btn btn-link password-toggle" id="togglePassword" tabindex="-1">
										<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-eye" id="eyeIcon" viewbox="0 0 16 16">
											<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
											<path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
										</svg>
									</button>
								</div>
							</div>

							<div class="form-group mb-3 d-flex flex-column align-items-center">
								<div class="checkbox mb-3">
									<label>
										<input type="checkbox" name="_remember_me" class="form-check-input">
										Recordarme
									</label>
								</div>
							</div>

							<input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

							<div class="d-flex flex-column align-items-center">
								<button class="btn btn-lg btn-primary rounded-pill btn-login" type="submit" id="loginButton">
									<span id="loginButtonText">INICIAR SESIÓN</span>
									<span id="loginSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
								</button>
								<a href="{{ path('forget_password', {'dominio': dominio}) }}" class="btn btn-link text-white mt-2">¿Olvidaste tu contraseña?</a>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	<!-- Solo cargar SweetAlert2 y Bootstrap, NO auth-alerts.js -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		document.addEventListener('DOMContentLoaded', function () { // Password visibility toggle
const togglePassword = document.getElementById('togglePassword');
const passwordInput = document.getElementById('inputPassword');
const eyeIcon = document.getElementById('eyeIcon');

if (togglePassword && passwordInput && eyeIcon) {
togglePassword.addEventListener('click', function (e) {
e.preventDefault();

const type = passwordInput.type === 'password' ? 'text' : 'password';
passwordInput.type = type;

// Toggle eye icon
if (type === 'password') { // Show eye icon (password hidden)
eyeIcon.innerHTML = `
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                        `;
} else { // Show eye-slash icon (password visible)
eyeIcon.innerHTML = `
                            <path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7 7 0 0 0-2.79.588l.77.771A6 6 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755q-.247.248-.517.486z"/>
                            <path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829"/>
                            <path d="M3.35 5.47q-.27.24-.518.487A13 13 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7 7 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12z"/>
                        `;
}
});
}

// Mostrar error de autenticación si existe
{% if error %}
{% set errorType = app.session.get('_security.login.error_type', 'invalid_credentials') %}

let errorTitle = 'Error de Autenticación';
let errorMessage = '';
let errorIcon = 'error';{% if errorType == 'inactive_account' %}errorTitle = 'Cuenta Inactiva';
errorMessage = 'Tu cuenta está inactiva. Por favor, contacta al administrador para activarla.';
errorIcon = 'warning';
{% elseif errorType == 'insufficient_role' %}errorTitle = 'Acceso Denegado';
errorMessage = 'No tienes los permisos necesarios para acceder al sistema. Tu cuenta requiere permisos de administrador o líder. Por favor, contacta al administrador del sistema.';
errorIcon = 'error';
{% else %}errorMessage = 'El correo electrónico o la contraseña son incorrectos. Por favor, verifica tus credenciales e intenta nuevamente.';{% endif %}Swal.fire({
icon: errorIcon,
title: errorTitle,
text: errorMessage,
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0B3F61',
allowOutsideClick: true,
allowEscapeKey: true
}).then(() => { // Limpiar el error type de la sesión
{% if app.session.has('_security.login.error_type') %}
{# La sesión se limpiará en el próximo request #}{% endif %}

// Enfocar el campo de email para facilitar reintento
const emailField = document.getElementById('inputEmail');
if (emailField) {
emailField.focus();
emailField.select();
}
});{% endif %}
});
	</script>
{% endblock %}
