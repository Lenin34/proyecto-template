{% extends 'base-login.html.twig' %}

{% set dominio = app.request.get('dominio', 'ts') %}

{% block title %}Recuperar contraseña
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		/* Corregir fondo para evitar deformación */
		body.bg-dark {
			background: linear-gradient(to bottom, #0B3F61 0%, #586975 100%) !important;
			background-attachment: fixed !important;
			background-repeat: no-repeat !important;
			background-size: 100% 100% !important;
			min-height: 100vh !important;
		}

		/* Logo Responsivo (Igual que Login) */
		.logo-login {
			max-width: 200px;
			width: 100%;
			height: auto;
			margin-bottom: 1.5rem;
			filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.4)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
		}

		@media(max-width: 768px) {
			.logo-login {
				max-width: 150px;
			}
		}

		/* Contenedor principal alineado con login */
		.login-wrapper {
			width: 100%;
			max-width: 450px;
			margin: 0 auto;
		}

		/* Indicador de pasos (Adaptado a Dark Mode) */
		.step-indicator {
			display: flex;
			justify-content: center;
			margin-bottom: 2rem;
		}

		.step {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			color: rgba(255, 255, 255, 0.6);
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: bold;
			margin: 0 5px;
			transition: all 0.3s ease;
			font-size: 14px;
		}

		.step.active {
			background: #0d6efd;
			color: white;
			border-color: #0d6efd;
			transform: scale(1.1);
			box-shadow: 0 0 10px rgba(13, 110, 253, 0.5);
		}

		.step.completed {
			background: #198754; /* Success green */
			color: white;
			border-color: #198754;
		}

		.step-line {
			width: 40px;
			height: 2px;
			background: rgba(255, 255, 255, 0.1);
			margin-top: 17px;
			transition: all 0.3s ease;
		}

		.step-line.completed {
			background: #198754;
		}

		/* Títulos y Textos */
		.wizard-title {
			font-weight: 700;
			margin-bottom: 0.5rem;
			color: white;
			text-transform: uppercase;
			font-size: 1.5rem;
			letter-spacing: 1px;
		}

		.wizard-subtitle {
			color: rgba(255, 255, 255, 0.8);
			font-size: 0.95rem;
			margin-bottom: 2rem;
			font-weight: 300;
		}

		/* Inputs (Estilo Login) */
		.form-label {
			color: white !important;
			font-weight: 300;
			margin-bottom: 0.5rem;
			letter-spacing: 0.5px;
		}

		.wizard-input {
			border-radius: 50rem !important; /* Pill */
			padding: 12px 20px;
			font-size: 1rem;
			border: none;
			background-color: white;
			color: #212529;
			transition: all 0.3s ease;
		}

		.wizard-input:focus {
			box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
			outline: none;
		}

		/* Botones (Estilo Login) */
		.wizard-btn {
			border-radius: 50rem !important;
			padding: 12px 30px;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 1px;
			transition: all 0.3s ease;
			width: 100%;
		}

		.wizard-btn-primary {
			background-color: #0d6efd;
			border: none;
			color: white;
		}

		.wizard-btn-primary:hover {
			background-color: #0b5ed7;
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		}

		.wizard-btn-secondary {
			background: transparent;
			border: 1px solid rgba(255, 255, 255, 0.3);
			color: rgba(255, 255, 255, 0.8);
			margin-top: 10px;
		}

		.wizard-btn-secondary:hover {
			background: rgba(255, 255, 255, 0.1);
			color: white;
			border-color: white;
		}

		/* Password Toggle */
		.password-wrapper {
			position: relative;
		}

		.password-toggle {
			position: absolute;
			right: 15px;
			top: 50%;
			transform: translateY(-50%);
			background: none;
			border: none;
			color: #6c757d;
			cursor: pointer;
			padding: 5px;
			z-index: 10;
		}

		.password-toggle:hover {
			color: #0d6efd;
		}

		/* Pasos del wizard */
		.wizard-step {
			display: none;
			animation: fadeIn 0.5s ease-in-out;
		}

		.wizard-step.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.help-text {
			font-size: 0.85rem;
			color: rgba(255, 255, 255, 0.6);
			margin-top: 5px;
			text-align: center;
		}

		/* Spinner */
		.wizard-spinner {
			width: 20px;
			height: 20px;
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-top: 2px solid white;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			display: inline-block;
			vertical-align: middle;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
	</style>
{% endblock %}

{% block body %}
	<div class="bg-dark text-white d-flex align-items-center justify-content-center vh-100">
		<div class="container">
			<div class="row justify-content-center">
				<div class="col-md-7 col-lg-6">
					<div
						class="login-wrapper p-4 text-white">

						<!-- Logo -->
						<div class="text-center mb-4 d-flex flex-column align-items-center">
							<img src="{{ tenant_logo_url(dominio) }}" alt="Logo" class="logo-login"/>
						</div>

						<!-- Indicador de pasos -->
						<div class="step-indicator">
							<div class="step active" id="step-indicator-1">1</div>
							<div class="step-line" id="line-1-2"></div>
							<div class="step" id="step-indicator-2">2</div>
							<div class="step-line" id="line-2-3"></div>
							<div class="step" id="step-indicator-3">3</div>
						</div>

						<!-- Paso 1: Solicitar Email -->
						<div class="wizard-step active" id="wizard-step-1">
							<div class="text-center mb-4">
								<h3 class="wizard-title">Recuperar Contraseña</h3>
								<p class="wizard-subtitle">Ingrese su correo electrónico para recibir el código</p>
							</div>

							<form id="emailForm">
								<div class="form-group mb-4">
									<label for="email" class="form-label w-100 text-center">Correo Electrónico</label>
									<input type="email" class="form-control wizard-input text-center" id="email" name="email" required placeholder="ejemplo@correo.com">
								</div>

								<div class="d-flex flex-column align-items-center">
									<button type="submit" class="btn wizard-btn wizard-btn-primary mb-2" id="sendEmailBtn">
										<span id="sendEmailText">ENVIAR CÓDIGO</span>
										<div class="wizard-spinner d-none" id="sendEmailSpinner"></div>
									</button>
									<a href="{{ path('app_login', {'dominio': dominio}) }}" class="btn wizard-btn wizard-btn-secondary">
										VOLVER AL LOGIN
									</a>
								</div>
							</form>
						</div>

						<!-- Paso 2: Verificar Código -->
						<div class="wizard-step" id="wizard-step-2">
							<div class="text-center mb-4">
								<h3 class="wizard-title">Verificar Código</h3>
								<p class="wizard-subtitle">Ingrese el código de 6 dígitos enviado a su email</p>
							</div>

							<form id="codeForm">
								<div class="form-group mb-4">
									<label for="verificationCode" class="form-label w-100 text-center">Código de Verificación</label>
									<input type="text" class="form-control wizard-input text-center" id="verificationCode" name="verification_code" required maxlength="6" pattern="[0-9]{6}" placeholder="000000" style="font-size: 24px; letter-spacing: 5px; font-weight: bold;">
									<div class="help-text">Revise su bandeja de entrada y carpeta de spam</div>
								</div>

								<div class="d-flex flex-column align-items-center">
									<button type="submit" class="btn wizard-btn wizard-btn-primary mb-2" id="verifyCodeBtn">
										<span id="verifyCodeText">VERIFICAR CÓDIGO</span>
										<div class="wizard-spinner d-none" id="verifyCodeSpinner"></div>
									</button>
									<button type="button" class="btn wizard-btn wizard-btn-secondary" onclick="goToStep(1)">
										VOLVER
									</button>
								</div>
							</form>
						</div>

						<!-- Paso 3: Nueva Contraseña -->
						<div class="wizard-step" id="wizard-step-3">
							<div class="text-center mb-4">
								<h3 class="wizard-title">Nueva Contraseña</h3>
								<p class="wizard-subtitle">Establezca su nueva contraseña segura</p>
							</div>

							<form id="passwordForm">
								<div class="form-group mb-3">
									<label for="newPassword" class="form-label w-100 text-center">Nueva Contraseña</label>
									<div class="password-wrapper">
										<input type="password" class="form-control wizard-input" id="newPassword" name="new_password" required minlength="8" placeholder="Mínimo 8 caracteres">
										<button type="button" class="password-toggle" data-target="newPassword">
											<i class="fa fa-eye"></i>
										</button>
									</div>
								</div>

								<div class="form-group mb-4">
									<label for="confirmPassword" class="form-label w-100 text-center">Confirmar Contraseña</label>
									<div class="password-wrapper">
										<input type="password" class="form-control wizard-input" id="confirmPassword" name="confirm_password" required minlength="8" placeholder="Repita la contraseña">
										<button type="button" class="password-toggle" data-target="confirmPassword">
											<i class="fa fa-eye"></i>
										</button>
									</div>
									<div class="help-text" id="passwordMatchText">Debe coincidir con la contraseña anterior</div>
								</div>

								<div class="d-flex flex-column align-items-center">
									<button type="submit" class="btn wizard-btn wizard-btn-primary mb-2" id="changePasswordBtn">
										<span id="changePasswordText">CAMBIAR CONTRASEÑA</span>
										<div class="wizard-spinner d-none" id="changePasswordSpinner"></div>
									</button>
									<button type="button" class="btn wizard-btn wizard-btn-secondary" onclick="goToStep(2)">
										VOLVER
									</button>
								</div>
							</form>
						</div>

					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
let currentStep = 1;
let userEmail = '';
let verificationCode = '';

// Función para cambiar de paso
function goToStep(step) { // Ocultar paso actual
document.getElementById (`wizard-step-${currentStep}`).classList.remove('active');
document.getElementById (`step-indicator-${currentStep}`).classList.remove('active');

// Mostrar nuevo paso
currentStep = step;
document.getElementById (`wizard-step-${currentStep}`).classList.add('active');
document.getElementById (`step-indicator-${currentStep}`).classList.add('active');

// Actualizar indicadores
updateStepIndicators();

// Enfocar primer campo del nuevo paso
setTimeout(() => {
if (step === 1) {
document.getElementById('email').focus();
} else if (step === 2) {
document.getElementById('verificationCode').focus();
} else if (step === 3) {
document.getElementById('newPassword').focus();
}
}, 100);
}

// Actualizar indicadores visuales
function updateStepIndicators() {
for (let i = 1; i <= 3; i++) {
const indicator = document.getElementById (`step-indicator-${i}`);
const line = document.getElementById(`line-${i}-${
i + 1
}`);

if (i < currentStep) {
indicator.classList.add('completed');
indicator.classList.remove('active');
if (line) 
line.classList.add('completed');

} else if (i === currentStep) {
indicator.classList.add('active');
indicator.classList.remove('completed');
} else {
indicator.classList.remove('active', 'completed');
if (line) 
line.classList.remove('completed');

}
}
}

// Función para mostrar/ocultar contraseña
document.querySelectorAll('.password-toggle').forEach(button => {
button.addEventListener('click', function () {
const targetId = this.getAttribute('data-target');
const input = document.getElementById(targetId);
const icon = this.querySelector('i');

if (input.type === 'password') {
input.type = 'text';
icon.classList.remove('fa-eye');
icon.classList.add('fa-eye-slash');
} else {
input.type = 'password';
icon.classList.remove('fa-eye-slash');
icon.classList.add('fa-eye');
}
});
});

// Función para mostrar loading en botón
function showLoading(buttonId, spinnerId, textId) {
const button = document.getElementById(buttonId);
const spinner = document.getElementById(spinnerId);
const text = document.getElementById(textId);

button.disabled = true;
spinner.classList.remove('d-none');
text.classList.add('d-none');
}

// Función para ocultar loading en botón
function hideLoading(buttonId, spinnerId, textId) {
const button = document.getElementById(buttonId);
const spinner = document.getElementById(spinnerId);
const text = document.getElementById(textId);

button.disabled = false;
spinner.classList.add('d-none');
text.classList.remove('d-none');
}

// Paso 1: Enviar email
document.getElementById('emailForm').addEventListener('submit', function (e) {
e.preventDefault();

userEmail = document.getElementById('email').value;
showLoading('sendEmailBtn', 'sendEmailSpinner', 'sendEmailText');

fetch('{{ path('forget_password', {'dominio': dominio}) }}', {
method: 'POST',
body: new FormData(this),
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
}).then(response => response.json()).then(data => {
hideLoading('sendEmailBtn', 'sendEmailSpinner', 'sendEmailText');

if (data.success && data.show_verification_form) {
Swal.fire({
icon: 'success',
title: 'Código Enviado',
text: data.message,
timer: 2000,
showConfirmButton: false,
background: '#fff',
confirmButtonColor: '#0d6efd'
}).then(() => {
goToStep(2);
});
} else {
Swal.fire({
icon: 'error',
title: 'Error',
text: data.message || 'Error al enviar el código',
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0d6efd'
});
}
}).catch(error => {
hideLoading('sendEmailBtn', 'sendEmailSpinner', 'sendEmailText');
console.error('Error:', error);
Swal.fire({
icon: 'error',
title: 'Error de Conexión',
text: 'No se pudo enviar el código. Verifique su conexión.',
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0d6efd'
});
});
});

// Paso 2: Verificar código
document.getElementById('codeForm').addEventListener('submit', function (e) {
e.preventDefault();

verificationCode = document.getElementById('verificationCode').value;
showLoading('verifyCodeBtn', 'verifyCodeSpinner', 'verifyCodeText');

const formData = new FormData();
formData.append('verification_code', verificationCode);
formData.append('step', 'verify_code');

fetch('{{ path('verify_code', {'dominio': dominio}) }}', {
method: 'POST',
body: formData,
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
}).then(response => response.json()).then(data => {
hideLoading('verifyCodeBtn', 'verifyCodeSpinner', 'verifyCodeText');

if (data.success) {
Swal.fire({
icon: 'success',
title: 'Código Verificado',
text: data.message,
timer: 1500,
showConfirmButton: false,
confirmButtonColor: '#0d6efd'
}).then(() => {
goToStep(3);
});
} else {
Swal.fire({
icon: 'error',
title: 'Código Incorrecto',
text: data.message || 'El código ingresado no es válido',
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0d6efd'
}).then(() => {
document.getElementById('verificationCode').focus();
document.getElementById('verificationCode').select();
});
}
}).catch(error => {
hideLoading('verifyCodeBtn', 'verifyCodeSpinner', 'verifyCodeText');
console.error('Error:', error);
Swal.fire({
icon: 'error',
title: 'Error de Conexión',
text: 'No se pudo verificar el código. Intente nuevamente.',
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0d6efd'
});
});
});

// Paso 3: Cambiar contraseña
document.getElementById('passwordForm').addEventListener('submit', function (e) {
e.preventDefault();

const newPassword = document.getElementById('newPassword').value;
const confirmPassword = document.getElementById('confirmPassword').value;

// Validaciones
if (newPassword.length < 8) {
Swal.fire({
icon: 'error',
title: 'Contraseña muy corta',
text: 'La contraseña debe tener al menos 8 caracteres.',
confirmButtonText: 'Entendido',
confirmButtonColor: '#0d6efd'
});
return;
}

if (newPassword !== confirmPassword) {
Swal.fire({
icon: 'error',
title: 'Contraseñas no coinciden',
text: 'Las contraseñas deben ser idénticas.',
confirmButtonText: 'Corregir',
confirmButtonColor: '#0d6efd'
});
return;
}

showLoading('changePasswordBtn', 'changePasswordSpinner', 'changePasswordText');

const formData = new FormData();
formData.append('verification_code', verificationCode);
formData.append('new_password', newPassword);
formData.append('confirm_password', confirmPassword);
formData.append('step', 'change_password');

fetch('{{ path('verify_code', {'dominio': dominio}) }}', {
method: 'POST',
body: formData,
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
}).then(response => response.json()).then(data => {
hideLoading('changePasswordBtn', 'changePasswordSpinner', 'changePasswordText');

if (data.success) {
Swal.fire({
icon: 'success',
title: '¡Contraseña Actualizada!',
text: data.message,
confirmButtonText: 'Ir al Login',
confirmButtonColor: '#0d6efd'
}).then(() => {
window.location.href = '{{ path('app_login', {'dominio': dominio}) }}';
});
} else {
Swal.fire({
icon: 'error',
title: 'Error',
text: data.message || 'Error al cambiar la contraseña',
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0d6efd'
});
}
}).catch(error => {
hideLoading('changePasswordBtn', 'changePasswordSpinner', 'changePasswordText');
console.error('Error:', error);
Swal.fire({
icon: 'error',
title: 'Error de Conexión',
text: 'No se pudo cambiar la contraseña. Intente nuevamente.',
confirmButtonText: 'Intentar de nuevo',
confirmButtonColor: '#0d6efd'
});
});
});

// Validación en tiempo real de confirmación de contraseña
document.getElementById('confirmPassword').addEventListener('input', function () {
const newPassword = document.getElementById('newPassword').value;
const confirmPassword = this.value;
const matchText = document.getElementById('passwordMatchText');

if (confirmPassword && newPassword !== confirmPassword) {
this.style.borderColor = '#dc3545';
matchText.style.color = '#ff6b6b';
matchText.textContent = 'Las contraseñas no coinciden';
} else {
this.style.borderColor = 'white';
matchText.style.color = 'rgba(255, 255, 255, 0.6)';
matchText.textContent = 'Debe coincidir con la contraseña anterior';
}
});

// Formatear código de verificación (solo números)
document.getElementById('verificationCode').addEventListener('input', function () {
this.value = this.value.replace(/[^0-9]/g, '');
});

// Hacer goToStep global para los botones onclick
window.goToStep = goToStep;
});
	</script>
</body>{% endblock %}
