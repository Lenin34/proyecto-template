{{ form_start(form, {'attr': {'id': 'notification-form'}}) }}
<div class="form-row-modern">
	<div class="col-md-12">
		{{ form_row(form.title, {'label': 'Título', 'attr': {'class': 'form-control-modern'}, 'label_attr': {'class': 'form-label-modern'}}) }}
	</div>
</div>

<div class="form-row-modern">
	<div class="col-md-12">
		{{ form_row(form.message, {'label': 'Mensaje', 'attr': {'class': 'form-control-modern', 'rows': '5'}, 'label_attr': {'class': 'form-label-modern'}}) }}
	</div>
</div>

<div class="form-row-modern">
	<div class="col-md-12">
		{{ form_row(form.region, {'label': 'Región (opcional)', 'attr': {'class': 'form-control-modern'}, 'label_attr': {'class': 'form-label-modern'}}) }}
	</div>
</div>

<!-- Hidden input to store selected companies -->
<input type="hidden" name="selected_companies" id="selected-companies" value="{% if notification.companies is defined and notification.companies|length > 0 %}{{ notification.companies|map(c => c.id)|join(',') }}{% endif %}">

<!-- Hidden input to store selected region -->
<input type="hidden" name="selected_region" id="selected-region" value="{% if notification.region is defined and notification.region %}{{ notification.region.id }}{% endif %}">

<div class="d-flex justify-content-center col-12 text-center mt-5">
	<button type="button" class="btn-modern-submit" id="submit-notification">{{ button_label|default('ENVIAR') }}</button>
</div>

<!-- Modal for company selection -->
<div class="modal fade" id="companiesModal" tabindex="-1" aria-labelledby="companiesModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-a">
		<div class="modal-content">
			<div class="modal-body">
				<div class="d-flex justify-content-center align-items-center mb-3">
					<h5 class="modal-title-sntiasg m-0" id="companiesModalLabel">Seleccionar Empresas</h5>
				</div>

				<div id="companies-container"></div>

				<div class="d-flex justify-content-center align-items-center mt-5">
					<button type="button" class="btn-y" id="save-companies">Guardar</button>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Modal for notification confirmation -->
<div class="modal fade" id="confirmNotificationModal" tabindex="-1" aria-labelledby="confirmNotificationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content text-center p-3">
			<div class="modal-body modal-b">
				<h5 class="modal-title-sntiasg" id="confirmNotificationModalLabel">¿ESTÁ SEGUR@ DE MANDAR ESTA NOTIFICACIÓN?</h5>
				<div class="d-flex justify-content-center gap-2 mt-3">
					<button id="btnConfirmNotification" type="button" class="btn-y">{{ button_label|default('ENVIAR') }}</button>
				</div>
			</div>
		</div>
	</div>
</div>

{{ form_end(form) }}

<script>
	document.addEventListener('DOMContentLoaded', function () {
        const dominio = '{{ dominio }}';
        const selectedCompanies = [];
        let currentRegionId = null;
        let allCompaniesInRegion = false;

        // Get initially selected companies and region
        const initialSelectedCompanies = document.getElementById('selected-companies').value;
        const initialSelectedCompanyIds = initialSelectedCompanies ? initialSelectedCompanies.split(',') : [];
        const initialRegionId = document.getElementById('selected-region').value;

        // Get region select element
        const regionSelect = document.querySelector('[name="notification[region]"]');

        // Initialize selected companies
        if (initialSelectedCompanyIds.length > 0) {
            selectedCompanies.push(...initialSelectedCompanyIds);
        }

        // Set initial region if exists
        if (initialRegionId) {
            currentRegionId = initialRegionId;
            if (regionSelect) {
                regionSelect.value = initialRegionId;
            }
        }

        // Listen for region changes
        if (regionSelect) {
            regionSelect.addEventListener('change', function() {
                const newRegionId = this.value;
                
                if (newRegionId) {
                    currentRegionId = newRegionId;
                    loadCompaniesForRegion(newRegionId);
                } else {
                    currentRegionId = null;
                    loadAllCompanies();
                }
            });
        }

        // Load all companies
        function loadAllCompanies() {
            fetch(`/${dominio}/companies/all`)
                .then(response => response.json())
                .then(companies => {
                    displayCompanies(companies, null);
                })
                .catch(error => {
                    console.error('Error loading companies:', error);
                    fetch('{{ path('app_region_list', {'dominio': dominio}) }}')
                        .then(response => response.json())
                        .then(regions => {
                            const allCompaniesPromises = regions.map(region =>
                                fetch(`/${dominio}/region/${region.id}/companies`).then(r => r.json())
                            );
                            return Promise.all(allCompaniesPromises);
                        })
                        .then(companiesArrays => {
                            const allCompanies = companiesArrays.flat();
                            const uniqueCompanies = allCompanies.filter((company, index, self) =>
                                index === self.findIndex(c => c.id === company.id)
                            );
                            displayCompanies(uniqueCompanies, null);
                        })
                        .catch(err => {
                            console.error('Error loading all companies:', err);
                            alert('Error al cargar las empresas');
                        });
                });
        }

        // Load companies for a region
        function loadCompaniesForRegion(regionId) {
            fetch(`/${dominio}/region/${regionId}/companies`)
                .then(response => response.json())
                .then(companies => {
                    return fetch('{{ path('app_region_list', {'dominio': dominio}) }}')
                        .then(response => response.json())
                        .then(regions => {
                            const region = regions.find(r => r.id == regionId);
                            const regionName = region ? region.name : 'esta región';
                            displayCompanies(companies, regionName);
                        });
                })
                .catch(error => {
                    console.error('Error loading companies:', error);
                    alert('Error al cargar las empresas');
                });
        }

        // Display companies
        function displayCompanies(companies, regionName) {
            const companiesContainer = document.getElementById('companies-container');
            companiesContainer.innerHTML = '';

            if (companies.length === 0) {
                companiesContainer.innerHTML = '<div class="alert alert-info">No hay empresas disponibles</div>';
                const modal = new bootstrap.Modal(document.getElementById('companiesModal'));
                modal.show();
                return;
            }

            // Add "All companies in region" option
            if (regionName) {
                const allCompaniesDiv = document.createElement('div');
                allCompaniesDiv.className = 'form-check mb-3 p-3 border rounded bg-light';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input all-companies-checkbox';
                checkbox.id = 'all-companies-region';
                checkbox.value = 'all_region_' + currentRegionId;
                checkbox.checked = allCompaniesInRegion;

                const label = document.createElement('label');
                label.className = 'form-check-label fw-bold';
                label.htmlFor = 'all-companies-region';
                label.innerHTML = `<i class="fas fa-building me-2"></i>Todas las empresas de ${regionName}`;

                allCompaniesDiv.appendChild(checkbox);
                allCompaniesDiv.appendChild(label);
                companiesContainer.appendChild(allCompaniesDiv);

                checkbox.addEventListener('change', function() {
                    allCompaniesInRegion = this.checked;
                    document.querySelectorAll('.company-checkbox').forEach(cb => {
                        cb.checked = this.checked;
                        cb.disabled = this.checked;
                    });
                });

                const separator = document.createElement('hr');
                separator.className = 'my-3';
                companiesContainer.appendChild(separator);
            }

            // Add individual companies
            companies.forEach(company => {
                const companyDiv = document.createElement('div');
                companyDiv.className = 'form-check mb-2';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input company-checkbox';
                checkbox.id = `company-${company.id}`;
                checkbox.value = company.id;
                checkbox.checked = selectedCompanies.includes(company.id.toString()) || allCompaniesInRegion;
                checkbox.disabled = allCompaniesInRegion;

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `company-${company.id}`;
                label.textContent = company.name;

                companyDiv.appendChild(checkbox);
                companyDiv.appendChild(label);
                companiesContainer.appendChild(companyDiv);
            });

            const modal = new bootstrap.Modal(document.getElementById('companiesModal'));
            modal.show();
        }

        // Save companies
        document.getElementById('save-companies').addEventListener('click', function() {
            selectedCompanies.length = 0;

            const allCompaniesCheckbox = document.querySelector('.all-companies-checkbox');
            if (allCompaniesCheckbox && allCompaniesCheckbox.checked) {
                document.querySelectorAll('.company-checkbox').forEach(checkbox => {
                    selectedCompanies.push(checkbox.value);
                });
            } else {
                document.querySelectorAll('.company-checkbox:checked').forEach(checkbox => {
                    selectedCompanies.push(checkbox.value);
                });
            }

            document.getElementById('selected-companies').value = selectedCompanies.join(',');

            const modal = bootstrap.Modal.getInstance(document.getElementById('companiesModal'));
            modal.hide();
        });

        // Handle form submission
        const form = document.getElementById('notification-form');
        const submitButton = document.getElementById('submit-notification');
        const confirmButton = document.getElementById('btnConfirmNotification');

        submitButton.addEventListener('click', function () {
            // Show confirmation modal
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmNotificationModal'));
            confirmModal.show();
        });

        if (confirmButton) {
            confirmButton.addEventListener('click', function () {
                // Submit the form
                form.submit();

                // Hide the modal
                const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmNotificationModal'));
                confirmModal.hide();
            });
        }
    });
</script>
